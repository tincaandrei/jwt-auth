version: '3.9'

services:
  traefik:
    image: traefik:v2.11
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
    ports:
      - "8080:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - gateway

  auth-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: auth_user
      POSTGRES_PASSWORD: auth_pwd
      POSTGRES_DB: auth_db
    volumes:
      - auth_data:/var/lib/postgresql/data
    networks:
      - gateway

  auth-service:
    build: ./auth
    depends_on:
      - auth-db
    environment:
      DB_IP: auth-db
      DB_PORT: 5432
      DB_USER: auth_user
      DB_PASSWORD: auth_pwd
      DB_DBNAME: auth_db
      PORT: 8080
      JWT_SECRET: ${JWT_SECRET:-change_this_super_secret_key_at_least_256_bits}
    labels:
      - traefik.enable=true
      - traefik.http.routers.auth.rule=PathPrefix(`/auth`)
      - traefik.http.routers.auth.entrypoints=web
      - traefik.http.services.auth.loadbalancer.server.port=8080
    networks:
      - gateway

  user-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: user_user
      POSTGRES_PASSWORD: user_pwd
      POSTGRES_DB: user_db
    volumes:
      - user_data:/var/lib/postgresql/data
    networks:
      - gateway

  user-service:
    build: ./user
    depends_on:
      - user-db
    environment:
      DB_HOST: user-db
      DB_PORT: 5432
      DB_USER: user_user
      DB_PASSWORD: user_pwd
      DB_NAME: user_db
      PORT: 8081
      JWT_SECRET: ${JWT_SECRET:-change_this_super_secret_key_at_least_256_bits}
    labels:
      - traefik.enable=true
      - traefik.http.routers.user.rule=PathPrefix(`/users`)
      - traefik.http.routers.user.entrypoints=web
      - traefik.http.services.user.loadbalancer.server.port=8081
    networks:
      - gateway

networks:
  gateway:
    driver: bridge

volumes:
  auth_data:
  user_data:
